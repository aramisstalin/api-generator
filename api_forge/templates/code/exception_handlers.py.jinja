"""
Exception handlers.

Centralized exception handling with standardized error responses.
"""

from typing import Union
from fastapi import Request, status
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from sqlalchemy.exc import IntegrityError, SQLAlchemyError
import logging

from {{ app_name }}.core.exceptions import AppException

logger = logging.getLogger(__name__)


async def app_exception_handler(
    request: Request,
    exc: AppException
) -> JSONResponse:
    """
    Handle application exceptions.

    Returns standardized error response with:
    - error_code: Machine-readable error code
    - message: Human-readable error message
    - details: Additional error details (optional)
    - request_id: Correlation ID for tracing
    """
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error_code": exc.error_code,
            "message": exc.detail,
            "request_id": getattr(request.state, "correlation_id", None)
        },
        headers=exc.headers
    )


async def validation_exception_handler(
    request: Request,
    exc: RequestValidationError
) -> JSONResponse:
    """
    Handle Pydantic validation errors.

    Formats validation errors in a user-friendly way.
    """
    errors = []
    for error in exc.errors():
        errors.append({
            "field": ".".join(str(loc) for loc in error["loc"]),
            "message": error["msg"],
            "type": error["type"]
        })

    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content={
            "error_code": "VALIDATION_ERROR",
            "message": "Invalid request data",
            "details": errors,
            "request_id": getattr(request.state, "correlation_id", None)
        }
    )


async def integrity_error_handler(
    request: Request,
    exc: IntegrityError
) -> JSONResponse:
    """
    Handle database integrity errors.

    Converts database constraint violations to user-friendly messages.
    """
    logger.error(f"Database integrity error: {exc}", exc_info=True)

    # Extract constraint name if available
    error_message = str(exc.orig) if hasattr(exc, 'orig') else str(exc)

    # Parse common constraint violations
    if "unique constraint" in error_message.lower():
        message = "A record with this value already exists"
        error_code = "DUPLICATE_ENTRY"
    elif "foreign key constraint" in error_message.lower():
        message = "Referenced record does not exist"
        error_code = "INVALID_REFERENCE"
    elif "not null constraint" in error_message.lower():
        message = "Required field is missing"
        error_code = "MISSING_REQUIRED_FIELD"
    else:
        message = "Database constraint violation"
        error_code = "CONSTRAINT_VIOLATION"

    return JSONResponse(
        status_code=status.HTTP_409_CONFLICT,
        content={
            "error_code": error_code,
            "message": message,
            "request_id": getattr(request.state, "correlation_id", None)
        }
    )


async def sqlalchemy_error_handler(
    request: Request,
    exc: SQLAlchemyError
) -> JSONResponse:
    """
    Handle generic SQLAlchemy errors.

    Logs the error and returns a generic message to avoid exposing internals.
    """
    logger.error(f"Database error: {exc}", exc_info=True)

    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error_code": "DATABASE_ERROR",
            "message": "A database error occurred",
            "request_id": getattr(request.state, "correlation_id", None)
        }
    )


async def generic_exception_handler(
    request: Request,
    exc: Exception
) -> JSONResponse:
    """
    Handle unexpected exceptions.

    Catches all unhandled exceptions, logs them, and returns a generic error.
    """
    logger.error(
        f"Unhandled exception: {exc}",
        exc_info=True,
        extra={
            "request_id": getattr(request.state, "correlation_id", None),
            "path": request.url.path,
            "method": request.method
        }
    )

    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error_code": "INTERNAL_SERVER_ERROR",
            "message": "An unexpected error occurred",
            "request_id": getattr(request.state, "correlation_id", None)
        }
    )


def register_exception_handlers(app) -> None:
    """
    Register all exception handlers with FastAPI app.

    Args:
        app: FastAPI application instance
    """
    app.add_exception_handler(AppException, app_exception_handler)
    app.add_exception_handler(RequestValidationError, validation_exception_handler)
    app.add_exception_handler(IntegrityError, integrity_error_handler)
    app.add_exception_handler(SQLAlchemyError, sqlalchemy_error_handler)
    app.add_exception_handler(Exception, generic_exception_handler)